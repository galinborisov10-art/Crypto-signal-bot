# Signal Evaluation Pipeline Integration (ESB v1.0 §2.1-2.2)

## Overview

This document describes the integration of Entry Gating (ESB §2.1) and Confidence Threshold (ESB §2.2) evaluators into the main ICT signal generation flow.

## Architecture

All signals generated by the ICT Signal Engine must pass through a deterministic evaluation pipeline before execution:

```
Signal Generation → Entry Gating → Confidence Threshold → Execution
```

### Evaluation Order

1. **Signal Generation** - ICT signal is generated with raw confidence score
2. **Entry Gating (ESB §2.1)** - Signal is checked against 7 hard blockers
3. **Confidence Threshold (ESB §2.2)** - Signal confidence is validated against fixed thresholds
4. **Execution** - Signal proceeds to execution layer

### Integration Point

The evaluation pipeline is integrated in `ict_signal_engine.py` → `generate_signal()` method:

- **Location**: Step 12.1 and 12.2 (after signal type determination, before ICTSignal creation)
- **Files Modified**: `ict_signal_engine.py`
- **Evaluators Used**: `entry_gating_evaluator.py`, `confidence_threshold_evaluator.py`

## Entry Gating (ESB §2.1)

Entry Gating enforces 7 hard boolean blockers that determine if a signal is allowed to proceed.

### Gates Evaluated

| Gate | Field | Description | Block Condition |
|------|-------|-------------|-----------------|
| EG-06 | Structural Integrity | Required fields validation | Missing/invalid required fields |
| EG-01 | System State Validity | Check system operational status | DEGRADED, MAINTENANCE, EMERGENCY |
| EG-02 | Breaker Block Active | Check for active breaker block | Breaker block active in signal direction |
| EG-03 | Signal Collision Lock | Check for existing active signal | Active signal exists for symbol+timeframe |
| EG-04 | Cooldown Gate | Check cooldown period | Cooldown active for symbol+timeframe |
| EG-05 | Market Admissibility | Check market is tradeable | CLOSED, HALTED, INVALID |
| EG-07 | Duplicate Signature Block | Check for duplicate signals | Signature already seen |

### Required Context Fields

```python
{
    'symbol': str,              # Trading symbol (e.g., 'BTCUSDT')
    'timeframe': str,           # Timeframe (e.g., '1h', '4h')
    'direction': str,           # Signal direction (BUY, SELL, STRONG_BUY, STRONG_SELL)
    'raw_confidence': float,    # Confidence score (0-100)
    'system_state': str,        # OPERATIONAL, DEGRADED, MAINTENANCE, EMERGENCY
    'breaker_block_active': bool,
    'active_signal_exists': bool,
    'cooldown_active': bool,
    'market_state': str,        # OPEN, CLOSED, HALTED, INVALID
    'signature_already_seen': bool
}
```

### Blocking Behavior

- **One FAIL = HARD BLOCK** - Signal is immediately rejected
- Returns `None` from `generate_signal()`
- No further evaluations performed
- Signal is logged and discarded

### Helper Methods

The following helper methods build the signal context for Entry Gating:

```python
# ICTSignalEngine helper methods
_get_system_state() -> str
_check_breaker_block_active(ict_components, signal_type) -> bool
_check_active_signal(symbol, timeframe) -> bool
_check_cooldown(symbol, timeframe) -> bool
_get_market_state(symbol) -> str
_check_signature(symbol, timeframe, signal_type, timestamp) -> bool
```

**Note**: Current implementations return safe defaults. Full implementation can be enhanced in follow-up PRs.

## Confidence Threshold (ESB §2.2)

Confidence Threshold evaluates if a signal's raw confidence meets the fixed minimum threshold for its direction.

### Fixed Thresholds

| Signal Direction | Confidence Threshold |
|------------------|---------------------|
| BUY | 60.0 |
| SELL | 60.0 |
| STRONG_BUY | 70.0 |
| STRONG_SELL | 70.0 |

### Required Context Fields

```python
{
    'direction': str,           # Signal direction (BUY, SELL, STRONG_BUY, STRONG_SELL)
    'raw_confidence': float     # Confidence score (0-100)
}
```

### Blocking Behavior

- If `raw_confidence < threshold` → **HARD BLOCK**
- Returns `None` from `generate_signal()`
- Signal is logged and discarded

### Evaluation Logic

```python
# Pseudocode
if raw_confidence >= CONFIDENCE_THRESHOLDS[direction]:
    return True  # PASS
else:
    return False  # HARD BLOCK
```

## Integration Flow

### Step 12.1: Entry Gating

```python
# Build signal context
signal_context = {
    'symbol': symbol,
    'timeframe': timeframe,
    'direction': signal_type.value,
    'raw_confidence': confidence,
    'system_state': self._get_system_state(),
    'breaker_block_active': self._check_breaker_block_active(ict_components, signal_type),
    'active_signal_exists': self._check_active_signal(symbol, timeframe),
    'cooldown_active': self._check_cooldown(symbol, timeframe),
    'market_state': self._get_market_state(symbol),
    'signature_already_seen': self._check_signature(symbol, timeframe, signal_type, datetime.now())
}

# Evaluate Entry Gating
entry_allowed = evaluate_entry_gating(signal_context.copy())

if not entry_allowed:
    logger.info(f"⛔ Entry Gating BLOCKED: {symbol} {timeframe}")
    return None  # HARD BLOCK
```

### Step 12.2: Confidence Threshold

```python
# Build confidence context
confidence_context = {
    'direction': signal_type.value,
    'raw_confidence': confidence
}

# Evaluate Confidence Threshold
threshold_passed = evaluate_confidence_threshold(confidence_context.copy())

if not threshold_passed:
    logger.info(f"⛔ Confidence Threshold BLOCKED: {symbol} {timeframe} (confidence: {confidence:.2f})")
    return None  # HARD BLOCK
```

### Signal Creation

If both evaluations pass, the signal proceeds to creation:

```python
signal = ICTSignal(
    timestamp=datetime.now(),
    symbol=symbol,
    timeframe=timeframe,
    # ... rest of signal fields
)
```

## Logging

### Entry Gating Logs

**Blocked Signal:**
```
⛔ Entry Gating BLOCKED: BTCUSDT 1h
```

**Passed Signal:**
```
✅ PASSED Entry Gating: BTCUSDT 1h
```

### Confidence Threshold Logs

**Blocked Signal:**
```
⛔ Confidence Threshold BLOCKED: BTCUSDT 1h (confidence: 55.00)
```

**Passed Signal:**
```
✅ PASSED Confidence Threshold: BTCUSDT 1h (confidence: 65.00)
```

### Full Evaluation Success

```
============================================================
✅ ALL EVALUATIONS PASSED - PROCEEDING TO SIGNAL CREATION
============================================================
```

## Immutability Guarantees

Both evaluators preserve signal context immutability:

```python
# ICT Signal Engine uses .copy() to ensure immutability
entry_allowed = evaluate_entry_gating(signal_context.copy())
threshold_passed = evaluate_confidence_threshold(confidence_context.copy())
```

This ensures:
- Evaluators cannot mutate the original signal context
- Deterministic evaluation (same input → same output)
- No side effects

## Testing

### Unit Tests

- **Entry Gating**: `tests/test_entry_gating.py` (42 tests)
- **Confidence Threshold**: `tests/test_confidence_threshold.py` (24 tests)

### Integration Tests

- **Main Flow Integration**: `tests/test_main_flow_integration.py`
  - 8 integration tests (signal blocking, evaluation order, immutability)
  - 6 helper method tests
  - 1 end-to-end test

### Running Tests

```bash
# Without pytest (uses fallback mode)
python tests/test_entry_gating.py
python tests/test_confidence_threshold.py
python tests/test_main_flow_integration.py

# With pytest (recommended)
pytest tests/test_entry_gating.py -v
pytest tests/test_confidence_threshold.py -v
pytest tests/test_main_flow_integration.py -v
```

## Example Flow

### Scenario 1: Signal Passes All Checks

```
1. Signal Generated: BTCUSDT 1h BUY (confidence: 72.0)
2. Entry Gating: ✅ PASS (all gates pass)
3. Confidence Threshold: ✅ PASS (72.0 >= 60.0)
4. Result: Signal created and returned
```

### Scenario 2: Signal Blocked by Entry Gating

```
1. Signal Generated: BTCUSDT 1h BUY (confidence: 85.0)
2. Entry Gating: ⛔ BLOCKED (breaker_block_active = True)
3. Confidence Threshold: ⊘ NOT EVALUATED (short-circuit)
4. Result: None (signal discarded)
```

### Scenario 3: Signal Blocked by Confidence Threshold

```
1. Signal Generated: BTCUSDT 1h BUY (confidence: 55.0)
2. Entry Gating: ✅ PASS (all gates pass)
3. Confidence Threshold: ⛔ BLOCKED (55.0 < 60.0)
4. Result: None (signal discarded)
```

## Performance Considerations

- Entry Gating: ~7 boolean checks (O(1) complexity)
- Confidence Threshold: 1 comparison (O(1) complexity)
- Total overhead: Negligible (<1ms per signal)

## Future Enhancements

The following helper methods have default implementations and can be enhanced in future PRs:

1. **`_get_system_state()`** - Currently returns 'OPERATIONAL', can integrate with system health monitoring
2. **`_check_active_signal()`** - Currently returns False, can integrate with position manager
3. **`_check_cooldown()`** - Currently returns False, can implement time-based cooldown logic
4. **`_check_signature()`** - Currently returns False, can implement deduplication cache

## References

- **Entry Gating Evaluator**: `entry_gating_evaluator.py`
- **Confidence Threshold Evaluator**: `confidence_threshold_evaluator.py`
- **ICT Signal Engine**: `ict_signal_engine.py`
- **ESB v1.0 Documentation**: `docs/Expected_System_Behavior_v1.0.md`

## Change History

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-21 | 1.0 | Initial integration of Entry Gating and Confidence Threshold |

---

**Author**: galinborisov10-art  
**Date**: 2026-01-21  
**ESB Version**: v1.0 §2.1-2.2
