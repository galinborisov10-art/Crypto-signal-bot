# üîÑ Signal Deduplication System

## –ö–∞–∫–≤–æ –µ —Ç–æ–≤–∞?

–°–∏—Å—Ç–µ–º–∞ –∑–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –¥—É–±–ª–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ **–µ–¥–∏–Ω –∏ —Å—ä—â —Å–∏–≥–Ω–∞–ª –Ω—è–º–∞ –¥–∞ –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –¥–≤–∞ –ø—ä—Ç–∏** –≤ –∫—Ä–∞—Ç—ä–∫ –ø–µ—Ä–∏–æ–¥ –æ—Ç –≤—Ä–µ–º–µ.

---

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∏?

### 1. **–£–Ω–∏–∫–∞–ª–µ–Ω –∫–ª—é—á –∑–∞ –≤—Å–µ–∫–∏ —Å–∏–≥–Ω–∞–ª**
–í—Å–µ–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω —Å–∏–≥–Ω–∞–ª —Å–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞ –ø–æ:
- **Symbol** (–Ω–∞–ø—Ä. BTCUSDT)
- **Signal Type** (BUY –∏–ª–∏ SELL)
- **Timeframe** (–Ω–∞–ø—Ä. 4h)

–ü—Ä–∏–º–µ—Ä: `BTCUSDT_BUY_4h`

---

### 2. **Cooldown –ø–µ—Ä–∏–æ–¥**
–ö–æ–≥–∞—Ç–æ —Å–∏–≥–Ω–∞–ª –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω, —Ç–æ–π —Å–µ –∑–∞–ø–∞–∑–≤–∞ –≤ –∫–µ—à —Å:
- **Timestamp** - –∫–æ–≥–∞ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω
- **Confidence** - –Ω–∏–≤–æ –Ω–∞ —É–≤–µ—Ä–µ–Ω–æ—Å—Ç

**Cooldown = 60 –º–∏–Ω—É—Ç–∏** (–º–æ–∂–µ –¥–∞ —Å–µ –ø—Ä–æ–º–µ–Ω–∏)

---

### 3. **–ü—Ä–∞–≤–∏–ª–∞ –∑–∞ –±–ª–æ–∫–∏—Ä–∞–Ω–µ**

–°–∏–≥–Ω–∞–ª **–Ω—è–º–∞ –¥–∞ –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω** –∞–∫–æ:

‚úÖ **–°—ä—â–∏—è—Ç —Å–∏–≥–Ω–∞–ª –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –ø—Ä–µ–¥–∏ –ø–æ-–º–∞–ª–∫–æ –æ—Ç 60 –º–∏–Ω—É—Ç–∏**
```
BTCUSDT_BUY_4h –∏–∑–ø—Ä–∞—Ç–µ–Ω –≤ 10:00
BTCUSDT_BUY_4h –æ—Ç–Ω–æ–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω –≤ 10:30
‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω - –º–∏–Ω–∞–ª–∏ —Å–∞ —Å–∞–º–æ 30 –º–∏–Ω—É—Ç–∏
```

‚úÖ **Confidence –µ –ø–æ—á—Ç–∏ —Å—ä—â–æ—Ç–æ (¬±5%) –∏ cooldown –≤—Å–µ –æ—â–µ —Ç–µ—á–µ**
```
BTCUSDT_BUY_4h: 75% confidence –≤ 10:00
BTCUSDT_BUY_4h: 76% confidence –≤ 11:00
‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω - confidence —Å–µ –µ –ø—Ä–æ–º–µ–Ω–∏–ª —Å–∞–º–æ —Å 1%
```

---

### 4. **–ö–æ–≥–∞ —Å–∏–≥–Ω–∞–ª —â–µ –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –æ—Ç–Ω–æ–≤–æ?**

–°–∏–≥–Ω–∞–ª **—â–µ –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω** –∞–∫–æ:

‚úÖ **–ú–∏–Ω–∞–ª–∏ —Å–∞ –ø–æ–≤–µ—á–µ –æ—Ç 60 –º–∏–Ω—É—Ç–∏**
```
BTCUSDT_BUY_4h –≤ 10:00
BTCUSDT_BUY_4h –≤ 11:15
‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω - –º–∏–Ω–∞–ª–æ –µ 75 –º–∏–Ω—É—Ç–∏
```

‚úÖ **Confidence —Å–µ –µ –ø—Ä–æ–º–µ–Ω–∏–ª –∑–Ω–∞—á–∏—Ç–µ–ª–Ω–æ (>5%)**
```
BTCUSDT_BUY_4h: 70% –≤ 10:00
BTCUSDT_BUY_4h: 85% –≤ 10:30
‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω - confidence –µ —Å–∫–æ—á–∏–ª —Å 15%
```

‚úÖ **–°–∏–≥–Ω–∞–ª—ä—Ç –µ —Ä–∞–∑–ª–∏—á–µ–Ω**
```
BTCUSDT_BUY_4h –≤ 10:00
BTCUSDT_SELL_4h –≤ 10:10
‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω - —Ä–∞–∑–ª–∏—á–µ–Ω —Ç–∏–ø —Å–∏–≥–Ω–∞–ª
```

---

## üìä –ü—Ä–∏–º–µ—Ä–∏

### ‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏

```
10:00 - BTCUSDT_BUY_4h (75%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω
10:15 - BTCUSDT_BUY_4h (76%) ‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω (cooldown)
10:30 - BTCUSDT_BUY_4h (74%) ‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω (cooldown + —Å—ä—â confidence)
```

### ‚úÖ –ü–æ–∑–≤–æ–ª–µ–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏

```
10:00 - BTCUSDT_BUY_4h (75%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω
11:30 - BTCUSDT_BUY_4h (78%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω (–º–∏–Ω–∞–ª–∏ —Å–∞ 90 –º–∏–Ω)

10:00 - BTCUSDT_BUY_4h (70%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω
10:20 - BTCUSDT_BUY_4h (88%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω (–≥–æ–ª—è–º–∞ –ø—Ä–æ–º—è–Ω–∞ –≤ confidence)

10:00 - BTCUSDT_BUY_4h (75%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω
10:15 - ETHUSDT_BUY_4h (80%)  ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω (—Ä–∞–∑–ª–∏—á–µ–Ω —Å–∏–º–≤–æ–ª)

10:00 - BTCUSDT_BUY_4h (75%)  ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω
10:20 - BTCUSDT_SELL_4h (70%) ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω (—Ä–∞–∑–ª–∏—á–µ–Ω —Ç–∏–ø —Å–∏–≥–Ω–∞–ª)
```

---

## üßπ Automatic Cleanup

–°–∏—Å—Ç–µ–º–∞—Ç–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–∏—Å—Ç–≤–∞** —Å—Ç–∞—Ä–∏ –∑–∞–ø–∏—Å–∏:
- –°–∏–≥–Ω–∞–ª–∏ **–ø–æ-—Å—Ç–∞—Ä–∏ –æ—Ç 24 —á–∞—Å–∞** —Å–µ –ø—Ä–µ–º–∞—Ö–≤–∞—Ç –æ—Ç –∫–µ—à–∞
- –¢–æ–≤–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞ –ø—Ä–µ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç—Ç–∞
- Cleanup —Å–µ –∏–∑–≤—ä—Ä—à–≤–∞ –ø—Ä–∏ –≤—Å–µ–∫–∏ –Ω–æ–≤ —Å–∏–≥–Ω–∞–ª

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –¥–µ—Ç–∞–π–ª–∏

### –§—É–Ω–∫—Ü–∏–∏

#### `is_signal_already_sent()`
```python
is_signal_already_sent(symbol, signal_type, timeframe, confidence, cooldown_minutes=60)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**
- `symbol` - BTCUSDT, ETHUSDT, –∏ —Ç.–Ω.
- `signal_type` - BUY –∏–ª–∏ SELL
- `timeframe` - 1h, 4h, 1d, –∏ —Ç.–Ω.
- `confidence` - –ù–∏–≤–æ –Ω–∞ —É–≤–µ—Ä–µ–Ω–æ—Å—Ç (%)
- `cooldown_minutes` - –í—Ä–µ–º–µ –∑–∞ –∏–∑—á–∞–∫–≤–∞–Ω–µ (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ 60)

**–í—Ä—ä—â–∞:**
- `True` - –°–∏–≥–Ω–∞–ª—ä—Ç –µ –¥—É–±–ª–∏–∫–∞—Ç (–±–ª–æ–∫–∏—Ä–∞–π)
- `False` - –°–∏–≥–Ω–∞–ª—ä—Ç –µ –Ω–æ–≤ (–∏–∑–ø—Ä–∞—Ç–∏)

---

#### `cleanup_old_signals()`
```python
cleanup_old_signals()
```

–ü—Ä–µ–º–∞—Ö–≤–∞ –∑–∞–ø–∏—Å–∏ –ø–æ-—Å—Ç–∞—Ä–∏ –æ—Ç 24 —á–∞—Å–∞ –æ—Ç `SENT_SIGNALS_CACHE`.

---

### –ì–ª–æ–±–∞–ª–Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞

```python
SENT_SIGNALS_CACHE = {
    "BTCUSDT_BUY_4h": {
        'timestamp': datetime(2025, 11, 25, 10, 0, 0),
        'confidence': 75
    },
    "ETHUSDT_SELL_1h": {
        'timestamp': datetime(2025, 11, 25, 10, 30, 0),
        'confidence': 82
    }
}
```

---

## üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞—Ç–∞ –µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞–Ω–∞ –≤ `send_alert_signal()`:

```python
async def send_alert_signal(context: ContextTypes.DEFAULT_TYPE):
    # ... –∞–Ω–∞–ª–∏–∑ –∏ –∏–∑–±–æ—Ä –Ω–∞ –Ω–∞–π-–¥–æ–±—ä—Ä —Å–∏–≥–Ω–∞–ª ...
    
    # ‚ö° –ü–†–û–í–ï–†–ö–ê –ó–ê –î–£–ë–õ–ò–†–ê–ù–ï
    if is_signal_already_sent(symbol, analysis['signal'], settings['timeframe'], best_confidence, cooldown_minutes=60):
        logger.info(f"‚è≠Ô∏è –ü–†–û–ü–£–°–ö–ê–ú: {symbol} {analysis['signal']} –≤–µ—á–µ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –Ω–∞—Å–∫–æ—Ä–æ")
        return  # –ù–µ –∏–∑–ø—Ä–∞—â–∞–π —Å–∏–≥–Ω–∞–ª–∞
    
    # ... –∏–∑–ø—Ä–∞—Ç–∏ —Å–∏–≥–Ω–∞–ª–∞ ...
```

---

## üìù –õ–æ–≥–æ–≤–µ

–°–∏—Å—Ç–µ–º–∞—Ç–∞ –ª–æ–≥–≤–∞ –≤—Å—è–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞:

```
‚úÖ New signal: BTCUSDT_BUY_4h (75%)
‚è≠Ô∏è Skip BTCUSDT_BUY_4h: –ò–∑–ø—Ä–∞—Ç–µ–Ω –ø—Ä–µ–¥–∏ 30.5 –º–∏–Ω (cooldown: 60 –º–∏–Ω)
‚è≠Ô∏è Skip ETHUSDT_SELL_1h: –°—ä—â–∏—è confidence (82% vs 81%)
üßπ Cleaned 3 old signals from cache
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–º—è–Ω–∞ –Ω–∞ cooldown –ø–µ—Ä–∏–æ–¥

–ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ: **60 –º–∏–Ω—É—Ç–∏**

–ó–∞ –ø—Ä–æ–º—è–Ω–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–π –≤ `send_alert_signal()`:

```python
# –ü–æ-–∫—Ä–∞—Ç—ä–∫ cooldown (30 –º–∏–Ω—É—Ç–∏)
if is_signal_already_sent(symbol, analysis['signal'], settings['timeframe'], best_confidence, cooldown_minutes=30):
    return

# –ü–æ-–¥—ä–ª—ä–≥ cooldown (120 –º–∏–Ω—É—Ç–∏)
if is_signal_already_sent(symbol, analysis['signal'], settings['timeframe'], best_confidence, cooldown_minutes=120):
    return
```

---

## üéØ –†–µ–∑—É–ª—Ç–∞—Ç

### –ü—Ä–µ–¥–∏ (–ë–ï–ó –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è):
```
10:00 - üü¢ BTCUSDT BUY 75% ‚úÖ
10:15 - üü¢ BTCUSDT BUY 76% ‚úÖ (–¥—É–±–ª–∏–∫–∞—Ç!)
10:30 - üü¢ BTCUSDT BUY 74% ‚úÖ (–¥—É–±–ª–∏–∫–∞—Ç!)
10:45 - üü¢ BTCUSDT BUY 77% ‚úÖ (–¥—É–±–ª–∏–∫–∞—Ç!)
```
**–ü—Ä–æ–±–ª–µ–º:** 4 –µ–¥–Ω–∞–∫–≤–∏ —Å—ä–æ–±—â–µ–Ω–∏—è –∑–∞ 45 –º–∏–Ω—É—Ç–∏!

---

### –°–ª–µ–¥ (–° –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è):
```
10:00 - üü¢ BTCUSDT BUY 75% ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω
10:15 - (skip) ‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω
10:30 - (skip) ‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω
10:45 - (skip) ‚ùå –ë–ª–æ–∫–∏—Ä–∞–Ω
11:15 - üü¢ BTCUSDT BUY 78% ‚úÖ –ò–∑–ø—Ä–∞—Ç–µ–Ω (cooldown –∏–∑—Ç–µ–∫—ä–ª)
```
**–†–µ–∑—É–ª—Ç–∞—Ç:** –°–∞–º–æ 2 —Å—ä–æ–±—â–µ–Ω–∏—è, –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–∏!

---

## ‚úÖ –ü—Ä–µ–¥–∏–º—Å—Ç–≤–∞

1. **–ß–∏—Å—Ç–∏ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - –±–µ–∑ —Å–ø–∞–º –æ—Ç –µ–¥–Ω–∞–∫–≤–∏ —Å–∏–≥–Ω–∞–ª–∏
2. **–ü–æ-–¥–æ–±—ä—Ä user experience** - —Å–∞–º–æ –≤–∞–∂–Ω–∏ –ø—Ä–æ–º–µ–Ω–∏
3. **–ù–∞–º–∞–ª–µ–Ω–∞ –Ω–∞—Ç–æ–≤–∞—Ä–µ–Ω–æ—Å—Ç** - –ø–æ-–º–∞–ª–∫–æ —Å—ä–æ–±—â–µ–Ω–∏—è
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –Ω–µ –∏–∑–∏—Å–∫–≤–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –¥–µ–π—Å—Ç–≤–∏–µ
5. **–ì—ä–≤–∫–∞–≤–æ** - cooldown –º–æ–∂–µ –ª–µ—Å–Ω–æ –¥–∞ —Å–µ –ø—Ä–æ–º–µ–Ω—è

---

## üîê –°–∏–≥—É—Ä–Ω–æ—Å—Ç

- –ö–µ—à—ä—Ç –µ **—Å–∞–º–æ –≤ –ø–∞–º–µ—Ç—Ç–∞** (–Ω–µ —Å–µ –∑–∞–ø–∏—Å–≤–∞ –Ω–∞ –¥–∏—Å–∫)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–∏—Å—Ç–≤–∞–Ω–µ** –Ω–∞ —Å—Ç–∞—Ä–∏ –∑–∞–ø–∏—Å–∏
- **–ù–µ –∑–∞—Å—è–≥–∞ —Ä—ä—á–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏** (—Å–∞–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏)

---

**üí° –°—ä–≤–µ—Ç:** –ó–∞ –¥–∞ –≤–∏–¥–∏—à –±–ª–æ–∫–∏—Ä–∞–Ω–∏—Ç–µ —Å–∏–≥–Ω–∞–ª–∏, –ø—Ä–æ–≤–µ—Ä–∏ –ª–æ–≥–æ–≤–µ—Ç–µ —Å `tail -f /path/to/logs`
