name: Test SSH Connection

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Diagnose SSH Connection
      run: |
        echo "=== SSH Configuration Diagnostics ==="
        echo ""
        
        # Check if secrets are set
        echo "1. Checking GitHub Secrets:"
        if [ -n "${{ secrets.DO_HOST }}" ]; then
          echo "   ‚úÖ DO_HOST is set: ${{ secrets.DO_HOST }}"
        else
          echo "   ‚ùå DO_HOST is MISSING"
        fi
        
        if [ -n "${{ secrets.DO_USERNAME }}" ]; then
          echo "   ‚úÖ DO_USERNAME is set: ${{ secrets.DO_USERNAME }}"
        else
          echo "   ‚ùå DO_USERNAME is MISSING"
        fi
        
        if [ -n "${{ secrets.DO_SSH_KEY }}" ]; then
          echo "   ‚úÖ DO_SSH_KEY is set (length: ${#DO_SSH_KEY} chars)"
          
          # Check key format
          echo "${{ secrets.DO_SSH_KEY }}" > /tmp/key
          
          if grep -q "BEGIN.*PRIVATE KEY" /tmp/key; then
            echo "   ‚úÖ SSH key has proper header"
          else
            echo "   ‚ùå SSH key is missing proper header (should start with -----BEGIN)"
          fi
          
          if grep -q "END.*PRIVATE KEY" /tmp/key; then
            echo "   ‚úÖ SSH key has proper footer"
          else
            echo "   ‚ùå SSH key is missing proper footer (should end with -----END)"
          fi
          
          # Try to validate key
          chmod 600 /tmp/key
          if ssh-keygen -l -f /tmp/key 2>/dev/null; then
            echo "   ‚úÖ SSH key is valid"
          else
            echo "   ‚ùå SSH key is INVALID or corrupted"
          fi
          
          rm -f /tmp/key
        else
          echo "   ‚ùå DO_SSH_KEY is MISSING"
        fi
        
        echo ""
        echo "2. Testing network connectivity:"
        if [ -n "${{ secrets.DO_HOST }}" ]; then
          if ping -c 2 ${{ secrets.DO_HOST }} >/dev/null 2>&1; then
            echo "   ‚úÖ Host is reachable (ping successful)"
          else
            echo "   ‚ö†Ô∏è Host ping failed (may be blocking ICMP)"
          fi
          
          if nc -zv ${{ secrets.DO_HOST }} 22 2>&1 | grep -q succeeded; then
            echo "   ‚úÖ SSH port 22 is open"
          else
            echo "   ‚ùå SSH port 22 is CLOSED or unreachable"
          fi
        fi
        
        echo ""
        echo "3. Attempting SSH connection:"
        if [ -n "${{ secrets.DO_HOST }}" ] && [ -n "${{ secrets.DO_USERNAME }}" ] && [ -n "${{ secrets.DO_SSH_KEY }}" ]; then
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/test_key
          chmod 600 ~/.ssh/test_key
          
          ssh -v -i ~/.ssh/test_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            -o BatchMode=yes \
            ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} \
            "echo 'SSH CONNECTION SUCCESSFUL'; whoami; pwd" 2>&1 | tail -30
          
          SSH_EXIT=$?
          
          if [ $SSH_EXIT -eq 0 ]; then
            echo ""
            echo "‚úÖ‚úÖ‚úÖ SSH CONNECTION WORKS! ‚úÖ‚úÖ‚úÖ"
          else
            echo ""
            echo "‚ùå SSH connection failed (exit code: $SSH_EXIT)"
            echo ""
            echo "Common issues:"
            echo "  - Wrong SSH key (use: ssh-keygen -t ed25519 on server)"
            echo "  - Key not added to ~/.ssh/authorized_keys on server"
            echo "  - Wrong username (try 'root' or check DigitalOcean console)"
            echo "  - Firewall blocking port 22"
            echo "  - Wrong IP address"
          fi
          
          rm -f ~/.ssh/test_key
        else
          echo "‚ùå Cannot test - secrets are missing"
        fi
        
        echo ""
        echo "=== Diagnostics Complete ==="
