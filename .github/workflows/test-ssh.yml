name: Test SSH Connection

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” Test ALL Possible SSH Keys
      run: |
        echo "=== AUTO-DISCOVER SSH KEYS ON SERVER ==="
        echo ""
        
        if [ -z "${{ secrets.DO_HOST }}" ] || [ -z "${{ secrets.DO_USERNAME }}" ]; then
          echo "âŒ DO_HOST or DO_USERNAME not set in secrets"
          exit 1
        fi
        
        HOST="${{ secrets.DO_HOST }}"
        USER="${{ secrets.DO_USERNAME }}"
        
        echo "Target: $USER@$HOST"
        echo ""
        
        # Test with GitHub Secret key first
        if [ -n "${{ secrets.DO_SSH_KEY }}" ]; then
          echo "=== TESTING GITHUB SECRET KEY ==="
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/github_key
          chmod 600 ~/.ssh/github_key
          
          if ssh -v -i ~/.ssh/github_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            -o BatchMode=yes \
            $USER@$HOST \
            "echo 'âœ… GITHUB KEY WORKS'; ls -la ~/.ssh/" 2>&1 | grep -q "GITHUB KEY WORKS"; then
            
            echo "âœ…âœ…âœ… GITHUB SECRET KEY WORKS! âœ…âœ…âœ…"
            echo ""
            echo "Available SSH keys on server:"
            ssh -i ~/.ssh/github_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $USER@$HOST \
              "ls -lh ~/.ssh/id_* ~/.ssh/*_rsa ~/.ssh/*_ed25519 2>/dev/null || echo 'No standard keys found'"
            
            rm -f ~/.ssh/github_key
            exit 0
          else
            echo "âŒ GitHub secret key FAILED"
            echo ""
          fi
          
          rm -f ~/.ssh/github_key
        fi
        
        echo "=== TRYING PASSWORD-LESS SSH ==="
        # Try without key (in case password auth or agent forwarding works)
        if ssh -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o PasswordAuthentication=no \
          -o ConnectTimeout=10 \
          $USER@$HOST \
          "echo 'âœ… KEYLESS WORKS'; find ~/.ssh -type f -name 'id_*' -o -name '*_rsa' -o -name '*_ed25519' 2>/dev/null" 2>&1 | grep -q "KEYLESS WORKS"; then
          
          echo "âœ… Password-less SSH works!"
          echo ""
          echo "SSH keys found on server:"
          ssh -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $USER@$HOST \
            "ls -lh ~/.ssh/"
          exit 0
        fi
        
        echo "âŒ No working SSH method found"
        echo ""
        echo "=== TROUBLESHOOTING ==="
        echo ""
        echo "1. Check if SSH port is open:"
        nc -zv $HOST 22 2>&1
        echo ""
        
        echo "2. Ping server:"
        ping -c 2 $HOST 2>&1 | head -5
        echo ""
        
        echo "3. To fix, run on DigitalOcean server:"
        echo "   ssh root@$HOST"
        echo "   ssh-keygen -t ed25519 -f ~/.ssh/github_deploy -N \"\""
        echo "   cat ~/.ssh/github_deploy.pub >> ~/.ssh/authorized_keys"
        echo "   cat ~/.ssh/github_deploy"
        echo ""
        echo "   Copy the output and add to GitHub Secrets as DO_SSH_KEY"

