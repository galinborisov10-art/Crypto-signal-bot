name: Auto-Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # 04:00 Bulgarian time (UTC+2)
  workflow_dispatch:  # Ð ÑŠÑ‡Ð½Ð¾ Ð¿ÑƒÑÐºÐ°Ð½Ðµ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Digital Ocean
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/Crypto-signal-bot
            
            echo "ðŸ“¥ Downloading latest files from GitHub..."
            wget -q -O bot.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/bot.py"
            wget -q -O luxalgo_sr_mtf.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/luxalgo_sr_mtf.py"
            wget -q -O luxalgo_ict_concepts.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/luxalgo_ict_concepts.py"
            wget -q -O luxalgo_chart_generator.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/luxalgo_chart_generator.py"
            wget -q -O luxalgo_ict_analysis.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/luxalgo_ict_analysis.py"
            wget -q -O ml_engine.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/ml_engine.py"
            wget -q -O ml_predictor.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/ml_predictor.py"
            wget -q -O backtesting.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/backtesting.py"
            wget -q -O daily_reports.py "https://raw.githubusercontent.com/galinborisov10-art/Crypto-signal-bot/main/daily_reports.py"
            
            echo "ðŸ”„ Restarting bot service..."
            systemctl restart crypto-bot || true
            
            sleep 5
            echo "âœ… Deploy complete!"
          EOF
      
      - name: Send Success Notification
        if: success()
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MESSAGE="ðŸŒ… Ð”ÐÐ•Ð’Ð•Ð AUTO-DEPLOY!%0A%0Aâœ… Ð¤Ð°Ð¹Ð»Ð¾Ð²ÐµÑ‚Ðµ ÑÐ° Ð¾Ð±Ð½Ð¾Ð²ÐµÐ½Ð¸%0Aâœ… Ð‘Ð¾Ñ‚ÑŠÑ‚ Ðµ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½%0Aâœ… ML Ð¼Ð¾Ð´ÐµÐ»ÑŠÑ‚ ÑÐµ Ð¿Ñ€ÐµÐ¾Ð±ÑƒÑ‡Ð°Ð²Ð°%0A%0Aâ° $(date '+%H:%M:%S %d.%m.%Y')"
          else
            MESSAGE="ðŸš€ AUTO-DEPLOY Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!%0A%0Aâœ… Ð¤Ð°Ð¹Ð»Ð¾Ð²ÐµÑ‚Ðµ ÑÐ° Ð¾Ð±Ð½Ð¾Ð²ÐµÐ½Ð¸%0Aâœ… Ð‘Ð¾Ñ‚ÑŠÑ‚ Ðµ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½%0A%0Aâ° $(date '+%H:%M:%S %d.%m.%Y')"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "disable_notification=false" || echo "Telegram notification failed but deploy succeeded"
      
      - name: Send Failure Notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "disable_notification=false" \
            -d "text=âŒ AUTO-DEPLOY ÐÐ•Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!%0A%0AÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸ GitHub Actions Ð»Ð¾Ð³Ð¾Ð²ÐµÑ‚Ðµ:%0Ahttps://github.com/galinborisov10-art/Crypto-signal-bot/actions"
