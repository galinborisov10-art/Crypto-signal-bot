name: Auto-Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # 04:00 Bulgarian time (UTC+2)
  workflow_dispatch:  # Ð ÑŠÑ‡Ð½Ð¾ Ð¿ÑƒÑÐºÐ°Ð½Ðµ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Digital Ocean
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/Crypto-signal-bot
            
            echo "ðŸ“¥ Syncing with GitHub repository..."
            
            # Initialize git if not already done
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/galinborisov10-art/Crypto-signal-bot.git
            fi
            
            # Ð—Ð°Ð¿Ð°Ð·Ð¸ restart flag Ð°ÐºÐ¾ ÑÑŠÑ‰ÐµÑÑ‚Ð²ÑƒÐ²Ð°
            if [ -f .restart_requested ]; then
              cp .restart_requested /tmp/.restart_requested_backup
              echo "ðŸ’¾ Restart flag Ð·Ð°Ð¿Ð°Ð·ÐµÐ½ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾"
            fi
            
            # Reset any local changes and pull latest
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # Ð’ÑŠÐ·ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ restart flag
            if [ -f /tmp/.restart_requested_backup ]; then
              mv /tmp/.restart_requested_backup .restart_requested
              echo "â™»ï¸ Restart flag Ð²ÑŠÐ·ÑÑ‚Ð°Ð½Ð¾Ð²ÐµÐ½"
            fi
            
            echo "âœ… All files updated from GitHub!"
            
            echo "ðŸ”„ Restarting bot service..."
            systemctl restart crypto-bot
            
            # Wait for service to start
            sleep 3
            
            # Check if bot is running
            if systemctl is-active --quiet crypto-bot; then
              echo "âœ… Deploy complete! Bot is running successfully."
            else
              echo "âŒ WARNING: Bot service is not active!"
              systemctl status crypto-bot --no-pager
              exit 1
            fi
          EOF
      
      - name: Send Success Notification
        if: success()
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MESSAGE="ðŸŒ… Ð”ÐÐ•Ð’Ð•Ð AUTO-DEPLOY Ð—ÐÐ’ÐªÐ Ð¨Ð•Ð!%0A%0Aâœ… Ð¤Ð°Ð¹Ð»Ð¾Ð²ÐµÑ‚Ðµ ÑÐ° Ð¾Ð±Ð½Ð¾Ð²ÐµÐ½Ð¸%0Aâœ… Ð‘Ð¾Ñ‚ÑŠÑ‚ Ðµ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾%0Aâœ… ML Ð¼Ð¾Ð´ÐµÐ»ÑŠÑ‚ ÑÐµ Ð¿Ñ€ÐµÐ¾Ð±ÑƒÑ‡Ð°Ð²Ð°%0A%0Aâ° $(date '+%H:%M:%S %d.%m.%Y')%0A%0AðŸŽ¯ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð’ÑÐ¸Ñ‡ÐºÐ¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð¸ Ð¿ÐµÑ€Ñ„ÐµÐºÑ‚Ð½Ð¾!"
          else
            MESSAGE="ðŸš€ DEPLOY Ð—ÐÐ’ÐªÐ Ð¨Ð•Ð Ð£Ð¡ÐŸÐ•Ð¨ÐÐž!%0A%0Aâœ… Ð¤Ð°Ð¹Ð»Ð¾Ð²ÐµÑ‚Ðµ ÑÐ° Ð¾Ð±Ð½Ð¾Ð²ÐµÐ½Ð¸ Ð¾Ñ‚ GitHub%0Aâœ… Ð‘Ð¾Ñ‚ÑŠÑ‚ Ðµ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð¸%0Aâœ… ÐŸÑ€Ð¾Ð¼ÐµÐ½Ð¸Ñ‚Ðµ ÑÐ° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸ Ð½Ð° ÑÑŠÑ€Ð²ÑŠÑ€Ð°%0A%0Aâ° Ð’Ñ€ÐµÐ¼Ðµ: $(date '+%H:%M:%S %d.%m.%Y')%0A%0AðŸŽ¯ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Production ready!"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "disable_notification=false" || echo "Telegram notification failed but deploy succeeded"
      
      - name: Send Failure Notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "disable_notification=false" \
            -d "text=âŒ AUTO-DEPLOY ÐÐ•Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!%0A%0AÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸ GitHub Actions Ð»Ð¾Ð³Ð¾Ð²ÐµÑ‚Ðµ:%0Ahttps://github.com/galinborisov10-art/Crypto-signal-bot/actions"
