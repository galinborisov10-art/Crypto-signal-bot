name: Auto-Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # 04:00 Bulgarian time (UTC+2)
  workflow_dispatch:  # –†—ä—á–Ω–æ –ø—É—Å–∫–∞–Ω–µ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Digital Ocean
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/Crypto-signal-bot
            
            echo "üì• Syncing with GitHub repository..."
            
            # Initialize git if not already done
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/galinborisov10-art/Crypto-signal-bot.git
            fi
            
            # –ó–∞–ø–∞–∑–∏ restart flag –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
            if [ -f .restart_requested ]; then
              cp .restart_requested /tmp/.restart_requested_backup
              echo "üíæ Restart flag –∑–∞–ø–∞–∑–µ–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ"
            fi
            
            # Reset any local changes and pull latest
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ restart flag
            if [ -f /tmp/.restart_requested_backup ]; then
              mv /tmp/.restart_requested_backup .restart_requested
              echo "‚ôªÔ∏è Restart flag –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω"
            fi
            
            echo "‚úÖ All files updated from GitHub!"
            
            # –ò–∑—Ç—Ä–∏–π Python cache —Ñ–∞–π–ª–æ–≤–µ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
            echo "üóëÔ∏è –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ Python cache..."
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true
            find . -type f -name "*.pyo" -delete 2>/dev/null || true
            echo "‚úÖ Python cache –∏–∑—á–∏—Å—Ç–µ–Ω"
            
            # –ì–µ–Ω–µ—Ä–∏—Ä–∞–π deployment info
            echo "üìã –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ deployment info..."
            COMMIT_SHA=$(git rev-parse --short HEAD)
            VERSION=$(cat VERSION || echo "2.0")
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            # Get PTB version (check if venv exists)
            if [ -f venv/bin/activate ]; then
              PTB_VERSION=$(source venv/bin/activate && python3 -m pip show python-telegram-bot 2>/dev/null | grep Version | awk '{print $2}')
            else
              PTB_VERSION=$(python3 -m pip show python-telegram-bot 2>/dev/null | grep Version | awk '{print $2}')
            fi
            PTB_VERSION=${PTB_VERSION:-"unknown"}
            
            # Create deployment info JSON using printf for safer string handling
            printf '{\n  "version": "%s",\n  "last_deployed": "%s",\n  "commit_sha": "%s",\n  "deployed_from": "github-actions",\n  "python_telegram_bot_version": "%s"\n}\n' \
              "$VERSION" "$TIMESTAMP" "$COMMIT_SHA" "$PTB_VERSION" > .deployment-info
            
            echo "üìã Deployment Info:"
            cat .deployment-info
            
            # Update systemd service file if it exists in repo
            if [ -f crypto-signal-bot.service ]; then
              echo "üîß Updating systemd service file..."
              cp crypto-signal-bot.service /etc/systemd/system/crypto-bot.service
              echo "‚úÖ Service file updated"
            fi
            
            echo "üîÑ Stopping bot service..."
            systemctl stop crypto-bot || true
            
            # Kill any remaining Python processes running bot.py (force cleanup)
            echo "üßπ Cleaning up any remaining bot processes..."
            pkill -9 -f "python.*bot.py" || true
            sleep 2
            
            # Verify no bot processes remain
            if pgrep -f "python.*bot.py" > /dev/null; then
              echo "‚ö†Ô∏è WARNING: Bot processes still running, forcing kill..."
              killall -9 python3 || true
              sleep 1
            fi
            
            echo "‚úÖ All bot processes terminated"
            
            # Reload systemd to pick up any service file changes
            echo "üîß Reloading systemd daemon..."
            systemctl daemon-reload
            
            echo "üöÄ Starting bot service..."
            systemctl start crypto-bot
            
            # Wait for service to start
            sleep 5
            
            # Run health check
            echo "üîç Running health check..."
            if [ -f health-check.sh ]; then
              chmod +x health-check.sh
              ./health-check.sh
            fi
            
            # Check if bot is running
            if systemctl is-active --quiet crypto-bot; then
              echo "‚úÖ Bot service is active"
              
              # Verify the bot process is actually running with new code
              BOT_PID=$(pgrep -f "python.*bot.py" | head -1)
              if [ -n "$BOT_PID" ]; then
                BOT_START_TIME=$(ps -p $BOT_PID -o lstart=)
                echo "‚úÖ Bot process PID: $BOT_PID"
                echo "‚úÖ Bot started at: $BOT_START_TIME"
                echo "‚úÖ Deploy complete! Bot is running with fresh code."
              else
                echo "‚ö†Ô∏è WARNING: Bot service is active but no bot.py process found!"
                exit 1
              fi
            else
              echo "‚ùå WARNING: Bot service is not active!"
              systemctl status crypto-bot --no-pager
              exit 1
            fi
          EOF
      
      - name: Get Deployment Info
        id: deploy_info
        run: |
          VERSION=$(ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "cat /root/Crypto-signal-bot/VERSION 2>/dev/null || echo '2.0'")
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
      
      - name: Send Success Notification
        if: success()
        run: |
          VERSION="${{ steps.deploy_info.outputs.version }}"
          COMMIT_SHA="${{ steps.deploy_info.outputs.commit_sha }}"
          
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MESSAGE="üåÖ –î–ù–ï–í–ï–ù AUTO-DEPLOY –ó–ê–í–™–†–®–ï–ù!%0A%0Aüì¶ –í–µ—Ä—Å–∏—è: v${VERSION}%0Aüîñ Commit: ${COMMIT_SHA}%0A‚úÖ –§–∞–π–ª–æ–≤–µ—Ç–µ —Å–∞ –æ–±–Ω–æ–≤–µ–Ω–∏%0A‚úÖ –ë–æ—Ç—ä—Ç –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ%0A‚úÖ ML –º–æ–¥–µ–ª–∏ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏%0A‚úÖ Python cache –∏–∑—á–∏—Å—Ç–µ–Ω%0A%0A‚è∞ $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          else
            MESSAGE="üöÄ DEPLOY –ó–ê–í–™–†–®–ï–ù –£–°–ü–ï–®–ù–û!%0A%0Aüì¶ –í–µ—Ä—Å–∏—è: v${VERSION}%0Aüîñ Commit: ${COMMIT_SHA}%0A‚úÖ –§–∞–π–ª–æ–≤–µ—Ç–µ —Å–∞ –æ–±–Ω–æ–≤–µ–Ω–∏ –æ—Ç GitHub%0A‚úÖ –ë–æ—Ç—ä—Ç –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –∏ —Ä–∞–±–æ—Ç–∏%0A‚úÖ Python cache –∏–∑—á–∏—Å—Ç–µ–Ω%0A%0A‚è∞ $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "disable_notification=false" || echo "Telegram notification failed but deploy succeeded"
      
      - name: Send Failure Notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "disable_notification=false" \
            -d "text=‚ùå AUTO-DEPLOY –ù–ï–£–°–ü–ï–®–ï–ù!%0A%0A–ü—Ä–æ–≤–µ—Ä–∏ GitHub Actions –ª–æ–≥–æ–≤–µ—Ç–µ:%0Ahttps://github.com/galinborisov10-art/Crypto-signal-bot/actions"
