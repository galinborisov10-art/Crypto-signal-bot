name: Auto-Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # 04:00 Bulgarian time (UTC+2)
  workflow_dispatch:  # –†—ä—á–Ω–æ –ø—É—Å–∫–∞–Ω–µ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Digital Ocean
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/Crypto-signal-bot
            
            echo "üì• Syncing with GitHub repository..."
            
            # Initialize git if not already done
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/galinborisov10-art/Crypto-signal-bot.git
            fi
            
            # –ó–∞–ø–∞–∑–∏ restart flag –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
            if [ -f .restart_requested ]; then
              cp .restart_requested /tmp/.restart_requested_backup
              echo "üíæ Restart flag –∑–∞–ø–∞–∑–µ–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ"
            fi
            
            # Reset any local changes and pull latest
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ restart flag
            if [ -f /tmp/.restart_requested_backup ]; then
              mv /tmp/.restart_requested_backup .restart_requested
              echo "‚ôªÔ∏è Restart flag –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω"
            fi
            
            echo "‚úÖ All files updated from GitHub!"
            
            # –ò–∑—Ç—Ä–∏–π Python cache —Ñ–∞–π–ª–æ–≤–µ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
            echo "üóëÔ∏è –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ Python cache..."
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true
            find . -type f -name "*.pyo" -delete 2>/dev/null || true
            
            echo "üîÑ Restarting bot service..."
            systemctl restart crypto-bot
            
            # Wait for service to start
            sleep 3
            
            # Check if bot is running
            if systemctl is-active --quiet crypto-bot; then
              echo "‚úÖ Deploy complete! Bot is running successfully."
            else
              echo "‚ùå WARNING: Bot service is not active!"
              systemctl status crypto-bot --no-pager
              exit 1
            fi
          EOF
      
      - name: Send Success Notification
        if: success()
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MESSAGE="üåÖ –î–ù–ï–í–ï–ù AUTO-DEPLOY –ó–ê–í–™–†–®–ï–ù!%0A%0A‚úÖ –§–∞–π–ª–æ–≤–µ—Ç–µ —Å–∞ –æ–±–Ω–æ–≤–µ–Ω–∏%0A‚úÖ –ë–æ—Ç—ä—Ç –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ%0A‚úÖ ML –º–æ–¥–µ–ª—ä—Ç —Å–µ –ø—Ä–µ–æ–±—É—á–∞–≤–∞%0A%0A‚è∞ $(date '+%H:%M:%S %d.%m.%Y')%0A%0AüéØ –°—Ç–∞—Ç—É—Å: –í—Å–∏—á–∫–æ —Ä–∞–±–æ—Ç–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–æ!"
          else
            MESSAGE="üöÄ DEPLOY –ó–ê–í–™–†–®–ï–ù –£–°–ü–ï–®–ù–û!%0A%0A‚úÖ –§–∞–π–ª–æ–≤–µ—Ç–µ —Å–∞ –æ–±–Ω–æ–≤–µ–Ω–∏ –æ—Ç GitHub%0A‚úÖ –ë–æ—Ç—ä—Ç –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –∏ —Ä–∞–±–æ—Ç–∏%0A‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∞–∫—Ç–∏–≤–Ω–∏ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞%0A%0A‚è∞ –í—Ä–µ–º–µ: $(date '+%H:%M:%S %d.%m.%Y')%0A%0AüéØ –°—Ç–∞—Ç—É—Å: Production ready!"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "disable_notification=false" || echo "Telegram notification failed but deploy succeeded"
      
      - name: Send Failure Notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "disable_notification=false" \
            -d "text=‚ùå AUTO-DEPLOY –ù–ï–£–°–ü–ï–®–ï–ù!%0A%0A–ü—Ä–æ–≤–µ—Ä–∏ GitHub Actions –ª–æ–≥–æ–≤–µ—Ç–µ:%0Ahttps://github.com/galinborisov10-art/Crypto-signal-bot/actions"
