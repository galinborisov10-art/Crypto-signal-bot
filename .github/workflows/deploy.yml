name: ğŸš€ Auto Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to DigitalOcean
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: ${{ secrets.DO_PORT || 22 }}
        script: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ STARTING AUTO-DEPLOY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Find project directory
          if [ -d ~/Crypto-signal-bot ]; then
            cd ~/Crypto-signal-bot
          elif [ -d /var/www/crypto-bot ]; then
            cd /var/www/crypto-bot
          elif [ -d /opt/crypto-bot ]; then
            cd /opt/crypto-bot
          else
            echo "âŒ Project directory not found!"
            exit 1
          fi
          
          echo "âœ… Project: $(pwd)"
          
          # Backup (non-blocking)
          echo "ğŸ’¾ Creating backup..."
          mkdir -p backups
          tar -czf "backups/backup_$(date +%Y%m%d_%H%M%S).tar.gz" \
            bot_stats.json trading_journal.json daily_reports.json \
            news_cache.json admin/credentials.json copilot_tasks.json \
            2>/dev/null || echo "âš ï¸ Some files missing (OK for first run)"
          echo "âœ… Backup complete"
          
          # Git pull
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin 2>&1 || echo "âš ï¸ Fetch warning (ignored)"
          
          CURRENT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          git pull origin main 2>&1 || echo "âš ï¸ Pull warning (ignored)"
          LATEST=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "âœ… Updated to: $(git log -1 --pretty=format:'%h - %s' 2>/dev/null || echo 'latest')"
          else
            echo "âœ… Already up to date"
          fi
          
          # Dependencies (non-blocking)
          echo "ğŸ“¦ Installing dependencies..."
          if [ -f requirements.txt ]; then
            if [ -d "venv" ]; then
              source venv/bin/activate 2>/dev/null || true
              pip install -r requirements.txt --quiet 2>&1 | grep -i "error" || echo "âœ… Packages OK"
            else
              pip3 install -r requirements.txt --quiet --break-system-packages 2>&1 | grep -i "error" || echo "âœ… Packages OK"
            fi
          else
            echo "âš ï¸ No requirements.txt found"
          fi
          
          # Restart bot
          echo "ğŸ”„ Restarting bot..."
          pkill -9 -f bot.py 2>/dev/null || true
          sleep 2
          
          # Start bot
          if [ -d "venv" ]; then
            nohup venv/bin/python bot.py > bot.log 2>&1 &
          else
            nohup python3 bot.py > bot.log 2>&1 &
          fi
          
          sleep 4
          
          # Verify
          if pgrep -f "bot.py" > /dev/null; then
            PID=$(pgrep -f "bot.py")
            echo "âœ… Bot running (PID: $PID)"
          else
            echo "âš ï¸ Bot process not detected (may still be starting)"
            tail -20 bot.log 2>/dev/null || echo "No logs yet"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOY COMPLETED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          exit 0
    
    - name: ğŸ“± Telegram Notification (Success)
      if: success()
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        COMMIT_HASH=$(git log -1 --pretty=format:"%h")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        
        MESSAGE="âœ… <b>AUTO-DEPLOY Ğ£Ğ¡ĞŸĞ•Ğ¨Ğ•Ğ!</b>%0A%0A"
        MESSAGE="${MESSAGE}ğŸš€ Ğ‘Ğ¾Ñ‚ÑŠÑ‚ Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²ĞµĞ½ Ğ¸ Ñ€ĞµÑÑ‚Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°Ğ½%0A%0A"
        MESSAGE="${MESSAGE}ğŸ“ <b>Commit:</b> ${COMMIT_HASH}%0A"
        MESSAGE="${MESSAGE}${COMMIT_MSG}%0A%0A"
        MESSAGE="${MESSAGE}ğŸ‘¤ <b>Author:</b> ${COMMIT_AUTHOR}%0A"
        MESSAGE="${MESSAGE}â° $(date '+%d.%m.%Y %H:%M UTC')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_OWNER_ID }}" \
          -d "parse_mode=HTML" \
          -d "disable_notification=false" \
          -d "text=${MESSAGE}"
    
    - name: ğŸ“± Telegram Notification (Failure)
      if: failure()
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        COMMIT_HASH=$(git log -1 --pretty=format:"%h")
        
        MESSAGE="âŒ <b>AUTO-DEPLOY ĞĞ•Ğ£Ğ¡ĞŸĞ•Ğ¨Ğ•Ğ!</b>%0A%0A"
        MESSAGE="${MESSAGE}ğŸ”´ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ğ¿Ñ€Ğ¸ deployment%0A%0A"
        MESSAGE="${MESSAGE}ğŸ“ <b>Commit:</b> ${COMMIT_HASH}%0A"
        MESSAGE="${MESSAGE}${COMMIT_MSG}%0A%0A"
        MESSAGE="${MESSAGE}ğŸ” <b>Action:</b> github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A"
        MESSAGE="${MESSAGE}â° $(date '+%d.%m.%Y %H:%M UTC')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_OWNER_ID }}" \
          -d "parse_mode=HTML" \
          -d "disable_notification=false" \
          -d "text=${MESSAGE}"
