name: üöÄ Auto Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v3
    
    - name: üîê Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: üöÄ Deploy to DigitalOcean
      continue-on-error: true
      id: deploy
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} << 'EOF'
          echo "üöÄ Starting deploy..."
          
          cd ~/Crypto-signal-bot 2>/dev/null || cd /var/www/crypto-bot 2>/dev/null || cd /opt/crypto-bot 2>/dev/null || exit 1
          echo "‚úÖ In $(pwd)"
          
          mkdir -p backups
          tar -czf backups/backup_$(date +%Y%m%d_%H%M%S).tar.gz *.json 2>/dev/null || true
          
          git fetch origin 2>&1 | head -5
          git pull origin main 2>&1 | head -10
          
          pip3 install -r requirements.txt --quiet --break-system-packages 2>&1 | grep -i "error" || true
          
          pkill -9 -f bot.py 2>/dev/null || true
          sleep 2
          
          if [ -d venv ]; then
            nohup venv/bin/python bot.py > bot.log 2>&1 &
          else
            nohup python3 bot.py > bot.log 2>&1 &
          fi
          
          sleep 3
          pgrep -f bot.py && echo "‚úÖ Bot started" || echo "‚ö†Ô∏è Bot starting..."
          
          echo "‚úÖ Deploy complete"
          exit 0
        EOF
    
    - name: üßπ Cleanup
      if: always()
      run: rm -f ~/.ssh/deploy_key
    
    - name: üì± Telegram Notification
      if: always()
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s" | sed 's/"/\\"/g')
        COMMIT_HASH=$(git log -1 --pretty=format:"%h")
        
        if [ "${{ steps.deploy.outcome }}" == "success" ]; then
          STATUS="‚úÖ –£–°–ü–ï–®–ï–ù"
          EMOJI="üöÄ"
        else
          STATUS="‚ö†Ô∏è –ó–ê–í–™–†–®–ï–ù"
          EMOJI="üîÑ"
        fi
        
        MESSAGE="${EMOJI} <b>AUTO-DEPLOY ${STATUS}</b>%0A%0A"
        MESSAGE="${MESSAGE}üìù ${COMMIT_HASH} - ${COMMIT_MSG}%0A"
        MESSAGE="${MESSAGE}‚è∞ $(date '+%d.%m %H:%M')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_OWNER_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=${MESSAGE}" > /dev/null 2>&1 || true
