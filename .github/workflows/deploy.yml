name: ğŸš€ Auto Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to DigitalOcean
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: ${{ secrets.DO_PORT || 22 }}
        script: |
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ STARTING AUTO-DEPLOY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Find project directory
          if [ -d ~/Crypto-signal-bot ]; then
            cd ~/Crypto-signal-bot
          elif [ -d /var/www/crypto-bot ]; then
            cd /var/www/crypto-bot
          elif [ -d /opt/crypto-bot ]; then
            cd /opt/crypto-bot
          else
            echo "âŒ Project directory not found!"
            exit 1
          fi
          
          PROJECT_DIR=$(pwd)
          echo "ğŸ“‚ Project: $PROJECT_DIR"
          
          # Backup current state
          echo "ğŸ’¾ Creating backup..."
          mkdir -p backups
          BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
          tar -czf "$BACKUP_FILE" \
            bot_stats.json \
            trading_journal.json \
            daily_reports.json \
            news_cache.json \
            admin/credentials.json \
            copilot_tasks.json \
            2>/dev/null || true
          echo "âœ… Backup: $BACKUP_FILE"
          
          # Git pull
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          CURRENT=$(git rev-parse HEAD)
          LATEST=$(git rev-parse origin/main)
          
          if [ "$CURRENT" == "$LATEST" ]; then
            echo "âœ… Already up to date!"
          else
            git pull origin main
            echo "âœ… Updated successfully"
            git log -1 --pretty=format:"ğŸ“ %h - %s"
            echo ""
          fi
          
          # Check dependencies
          echo "ğŸ“¦ Checking dependencies..."
          if git diff --name-only $CURRENT $LATEST 2>/dev/null | grep -q "requirements.txt"; then
            echo "âš ï¸ Updating packages..."
            if [ -d "venv" ]; then
              source venv/bin/activate
              pip install -r requirements.txt --upgrade
            else
              pip3 install -r requirements.txt --upgrade --break-system-packages || pip3 install -r requirements.txt --upgrade
            fi
            echo "âœ… Dependencies updated"
          else
            echo "âœ… No changes in requirements.txt"
          fi
          
          # Restart bot
          echo "ğŸ”„ Restarting bot..."
          
          # Try PM2 first
          if command -v pm2 &> /dev/null && pm2 list | grep -q "crypto-bot"; then
            echo "âŸ³ Restarting with PM2..."
            pm2 restart crypto-bot
            pm2 status crypto-bot
          else
            # Manual restart
            echo "âŸ³ Manual restart..."
            pkill -9 -f bot.py || true
            sleep 2
            
            if [ -d "venv" ]; then
              nohup venv/bin/python bot.py > bot.log 2>&1 &
            else
              nohup python3 bot.py > bot.log 2>&1 &
            fi
            
            sleep 3
            
            # Verify bot started
            if pgrep -f "bot.py" > /dev/null; then
              PID=$(pgrep -f "bot.py")
              echo "âœ… Bot running (PID: $PID)"
            else
              echo "âŒ Bot failed to start!"
              echo "Last 30 lines of log:"
              tail -30 bot.log
              exit 1
            fi
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOY COMPLETED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: ğŸ“± Telegram Notification (Success)
      if: success()
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        COMMIT_HASH=$(git log -1 --pretty=format:"%h")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        
        MESSAGE="âœ… <b>AUTO-DEPLOY Ğ£Ğ¡ĞŸĞ•Ğ¨Ğ•Ğ!</b>%0A%0A"
        MESSAGE="${MESSAGE}ğŸš€ Ğ‘Ğ¾Ñ‚ÑŠÑ‚ Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²ĞµĞ½ Ğ¸ Ñ€ĞµÑÑ‚Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°Ğ½%0A%0A"
        MESSAGE="${MESSAGE}ğŸ“ <b>Commit:</b> ${COMMIT_HASH}%0A"
        MESSAGE="${MESSAGE}${COMMIT_MSG}%0A%0A"
        MESSAGE="${MESSAGE}ğŸ‘¤ <b>Author:</b> ${COMMIT_AUTHOR}%0A"
        MESSAGE="${MESSAGE}â° $(date '+%d.%m.%Y %H:%M UTC')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_OWNER_ID }}" \
          -d "parse_mode=HTML" \
          -d "disable_notification=false" \
          -d "text=${MESSAGE}"
    
    - name: ğŸ“± Telegram Notification (Failure)
      if: failure()
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        COMMIT_HASH=$(git log -1 --pretty=format:"%h")
        
        MESSAGE="âŒ <b>AUTO-DEPLOY ĞĞ•Ğ£Ğ¡ĞŸĞ•Ğ¨Ğ•Ğ!</b>%0A%0A"
        MESSAGE="${MESSAGE}ğŸ”´ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ğ¿Ñ€Ğ¸ deployment%0A%0A"
        MESSAGE="${MESSAGE}ğŸ“ <b>Commit:</b> ${COMMIT_HASH}%0A"
        MESSAGE="${MESSAGE}${COMMIT_MSG}%0A%0A"
        MESSAGE="${MESSAGE}ğŸ” <b>Action:</b> github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A"
        MESSAGE="${MESSAGE}â° $(date '+%d.%m.%Y %H:%M UTC')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_OWNER_ID }}" \
          -d "parse_mode=HTML" \
          -d "disable_notification=false" \
          -d "text=${MESSAGE}"
