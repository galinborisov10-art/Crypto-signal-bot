name: ğŸ”§ Auto-Fix SSH Key

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/fix-ssh.yml'

jobs:
  fix-ssh:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”‘ Generate Fresh SSH Key
      id: keygen
      run: |
        cd /tmp
        ssh-keygen -t ed25519 -f deploy_key -N "" -C "github-actions-auto"
        
        echo "PUBLIC_KEY<<EOF" >> $GITHUB_OUTPUT
        cat deploy_key.pub >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "PRIVATE_KEY<<EOF" >> $GITHUB_OUTPUT
        cat deploy_key >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "âœ… SSH ĞºĞ»ÑÑ‡ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ°Ğ½"
    
    - name: ğŸ“‹ Display Keys
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”‘ PUBLIC KEY (Ğ·Ğ° ÑÑŠÑ€Ğ²ÑŠÑ€Ğ°):"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "${{ steps.keygen.outputs.PUBLIC_KEY }}"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” PRIVATE KEY (Ğ·Ğ° GitHub Secret DO_SSH_KEY):"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "${{ steps.keygen.outputs.PRIVATE_KEY }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ˜:"
        echo "1. ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ°Ğ¹ PUBLIC KEY Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸ Ğ½Ğ° ÑÑŠÑ€Ğ²ÑŠÑ€Ğ°:"
        echo "   ssh root@SERVER 'echo PUBLIC_KEY >> ~/.ssh/authorized_keys'"
        echo ""
        echo "2. ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ°Ğ¹ PRIVATE KEY Ğ¸ ÑĞ»Ğ¾Ğ¶Ğ¸ Ğ² GitHub Secret:"
        echo "   Settings â†’ Secrets â†’ DO_SSH_KEY â†’ Update"
        echo ""
        echo "3. Re-run Auto Deploy workflow"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: ğŸš€ Try Auto-Install (if DO_PASSWORD exists)
      continue-on-error: true
      run: |
        if [ -z "${{ secrets.DO_PASSWORD }}" ]; then
          echo "âš ï¸ DO_PASSWORD secret Ğ½Ğµ Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ - Ğ¸Ğ·Ğ¿Ğ¾Ğ»Ğ·Ğ²Ğ°Ğ¹ Ñ€ÑŠÑ‡Ğ½Ğ¸Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ³Ğ¾Ñ€Ğµ"
          exit 0
        fi
        
        echo "ğŸ”„ ĞĞ¿Ğ¸Ñ‚ Ğ·Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ° Ğ¸Ğ½ÑÑ‚Ğ°Ğ»Ğ°Ñ†Ğ¸Ñ Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ°..."
        
        sudo apt-get update -qq
        sudo apt-get install -y sshpass
        
        PUBLIC_KEY="${{ steps.keygen.outputs.PUBLIC_KEY }}"
        
        sshpass -p "${{ secrets.DO_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} \
          "mkdir -p ~/.ssh && chmod 700 ~/.ssh && echo '$PUBLIC_KEY' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && echo 'âœ… SSH ĞºĞ»ÑÑ‡ Ğ¸Ğ½ÑÑ‚Ğ°Ğ»Ğ¸Ñ€Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!'"
        
        if [ $? -eq 0 ]; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ…âœ…âœ… SSH ĞšĞ›Ğ®Ğ§ ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§ĞĞ Ğ˜ĞĞ¡Ğ¢ĞĞ›Ğ˜Ğ ĞĞ! âœ…âœ…âœ…"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Ğ¡ĞµĞ³Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸ GitHub Secret DO_SSH_KEY Ñ PRIVATE KEY Ğ³Ğ¾Ñ€Ğµ"
          echo "   Ğ¡Ğ»ĞµĞ´ Ñ‚Ğ¾Ğ²Ğ° Auto Deploy Ñ‰Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾!"
        fi
