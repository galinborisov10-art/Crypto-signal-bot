name: ğŸ” Install SSH Key via DigitalOcean API

on:
  workflow_dispatch:

jobs:
  install:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”‘ Generate SSH Key
      id: keygen
      run: |
        ssh-keygen -t ed25519 -f /tmp/deploy_key -N "" -C "github-actions-deploy"
        
        PUBLIC_KEY=$(cat /tmp/deploy_key.pub)
        PRIVATE_KEY=$(cat /tmp/deploy_key)
        
        echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_OUTPUT
        echo "PRIVATE_KEY<<EOF" >> $GITHUB_OUTPUT
        echo "$PRIVATE_KEY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "âœ… SSH ĞºĞ»ÑÑ‡ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ°Ğ½"
        echo "PUBLIC: $PUBLIC_KEY"
    
    - name: ğŸŒŠ Add SSH Key to DigitalOcean (if DO_API_TOKEN exists)
      if: ${{ secrets.DO_API_TOKEN != '' }}
      run: |
        echo "ğŸ“¡ Ğ”Ğ¾Ğ±Ğ°Ğ²ÑĞ¼ SSH ĞºĞ»ÑÑ‡ Ğ² DigitalOcean Ñ‡Ñ€ĞµĞ· API..."
        
        RESPONSE=$(curl -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.DO_API_TOKEN }}" \
          -d "{\"name\":\"github-actions-deploy-$(date +%s)\",\"public_key\":\"${{ steps.keygen.outputs.PUBLIC_KEY }}\"}" \
          https://api.digitalocean.com/v2/account/keys)
        
        echo "$RESPONSE"
        
        if echo "$RESPONSE" | grep -q '"ssh_key"'; then
          echo "âœ… SSH ĞºĞ»ÑÑ‡ Ğ´Ğ¾Ğ±Ğ°Ğ²ĞµĞ½ Ğ² DigitalOcean Ğ°ĞºĞ°ÑƒĞ½Ñ‚Ğ°!"
        else
          echo "âš ï¸ Ğ’ÑŠĞ·Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ³Ñ€ĞµÑˆĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑĞ½Ğµ"
        fi
    
    - name: ğŸ“‹ Display Private Key for GitHub Secret
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” PRIVATE KEY - ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ°Ğ¹ Ğ² GitHub Secret DO_SSH_KEY:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "${{ steps.keygen.outputs.PRIVATE_KEY }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ¯:"
        echo "1. GitHub â†’ Settings â†’ Secrets and variables â†’ Actions"
        echo "2. ĞĞ°Ğ¼ĞµÑ€Ğ¸ DO_SSH_KEY â†’ Update"
        echo "3. ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ°Ğ¹ Ñ†ĞµĞ»Ğ¸Ñ PRIVATE KEY Ğ¾Ñ‚Ğ³Ğ¾Ñ€Ğµ (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»Ğ½Ğ¾ BEGIN/END Ñ€ĞµĞ´Ğ¾Ğ²ĞµÑ‚Ğµ)"
        echo "4. Save â†’ Ğ¡Ğ»ĞµĞ´ Ñ‚Ğ¾Ğ²Ğ° Auto Deploy Ñ‰Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¸! âœ…"
