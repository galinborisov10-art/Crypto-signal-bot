name: Deploy to DigitalOcean Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Droplet (systemd)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} '
            set -euo pipefail

            # go to correct project dir
            cd /root/Crypto-signal-bot || { echo "project dir not found"; exit 2; }

            # update code
            git fetch --prune origin main
            git reset --hard origin/main

            # update venv deps if present
            if [ -f venv/bin/activate ]; then
              source venv/bin/activate
              pip install -r requirements.txt
              deactivate || true
            fi

            # restart systemd service
            sudo systemctl daemon-reload || true
            sudo systemctl restart crypto-bot.service
            sudo systemctl is-active --quiet crypto-bot.service && echo "service ok" || { echo "service failed"; exit 3; }
          '

      - name: Notify success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="✅ Deployment е изпълнен успешно!"

      - name: Notify failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="❌ Deployment НЕ е изпълнен успешно!"
