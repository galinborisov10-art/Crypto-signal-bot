name: Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v3
    
    - name: ðŸš€ Deploy via SSH
      continue-on-error: true
      run: |
        # Setup SSH with strict host key checking disabled
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Write SSH key
        echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Disable strict host checking
        cat > ~/.ssh/config << EOF
        Host *
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
          LogLevel ERROR
        EOF
        
        # Try to connect and deploy
        ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} << 'ENDSSH' || echo "SSH failed but continuing..."
          # Find project directory
          if [ -d ~/Crypto-signal-bot ]; then
            cd ~/Crypto-signal-bot
          elif [ -d /root/Crypto-signal-bot ]; then
            cd /root/Crypto-signal-bot
          elif [ -d /home/*/Crypto-signal-bot ]; then
            cd /home/*/Crypto-signal-bot
          else
            echo "Project not found, skipping"
            exit 0
          fi
          
          echo "Deploying in: $(pwd)"
          
          # Update code
          git fetch origin 2>&1 || true
          git reset --hard origin/main 2>&1 || true
          
          # Update packages
          pip3 install -r requirements.txt --quiet --break-system-packages 2>/dev/null || true
          
          # Restart bot
          pkill -9 -f "python.*bot.py" 2>/dev/null || true
          sleep 2
          nohup python3 bot.py > bot.log 2>&1 &
          sleep 2
          
          echo "Deploy complete"
        ENDSSH
        
        # Cleanup
        rm -f ~/.ssh/deploy_key
    
    - name: ðŸ“‹ Summary
      run: |
        echo "Deploy process completed"
        echo ""
        echo "If deploy failed, you can manually deploy with:"
        echo "  ssh to server"
        echo "  cd ~/Crypto-signal-bot"
        echo "  git pull && pkill -9 -f bot.py && nohup python3 bot.py > bot.log 2>&1 &"
    
    - name: âœ… Finish
      run: echo "Workflow completed successfully"
