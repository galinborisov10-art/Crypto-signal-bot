name: ğŸš€ Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: âœ… Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to DigitalOcean
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ Starting Auto-Deploy..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Setup SSH
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # SSH config
        cat > ~/.ssh/config << 'EOF'
        Host digitalocean
          HostName ${{ secrets.DO_HOST }}
          User ${{ secrets.DO_USERNAME }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        # Deploy
        ssh digitalocean << 'ENDSSH'
          set -e
          
          echo "ğŸ“‚ Navigating to project..."
          cd ~/Crypto-signal-bot || cd /root/Crypto-signal-bot || exit 1
          
          echo "ğŸ“Š Current commit: $(git rev-parse --short HEAD)"
          
          echo "ğŸ”„ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "âœ… New commit: $(git rev-parse --short HEAD)"
          
          echo "ğŸ“¦ Installing dependencies..."
          pip3 install -r requirements.txt --quiet --break-system-packages 2>/dev/null || pip3 install -r requirements.txt --quiet || true
          
          echo "ğŸ”„ Restarting bot..."
          pkill -9 -f "python.*bot.py" || true
          sleep 2
          
          nohup python3 bot.py > bot.log 2>&1 &
          sleep 3
          
          if pgrep -f "python.*bot.py"; then
            echo "âœ… Bot restarted successfully!"
            echo "ğŸ“„ Last 10 lines of log:"
            tail -10 bot.log
          else
            echo "âš ï¸ Bot may still be starting... Checking logs:"
            tail -20 bot.log
          fi
        ENDSSH
        
        DEPLOY_STATUS=$?
        
        # Cleanup
        rm -f ~/.ssh/deploy_key ~/.ssh/config
        
        if [ $DEPLOY_STATUS -eq 0 ]; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ…âœ…âœ… DEPLOY SUCCESSFUL! âœ…âœ…âœ…"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo "âŒ Deploy failed with exit code: $DEPLOY_STATUS"
          exit 1
        fi
